<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ChatHistoryState">
    <option name="serializedSessions">
      <map>
        <entry key="ceb90152-49c6-4bf8-91b0-c9da0bfbc910" value="{&quot;id&quot;:&quot;ceb90152-49c6-4bf8-91b0-c9da0bfbc910&quot;,&quot;name&quot;:&quot;Implementing Touch-to-Focus in QR Code Scanner&quot;,&quot;timestamp&quot;:1747116402286,&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;\u003cadditional_data\u003e\n\u003cespecially_relevant_code_snippet\u003e\napp/src/main/java/com/serranoie/app/qrrounder/MainActivity.kt\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/MainActivity.kt\npackage com.serranoie.app.qrrounder\n\nimport android.os.Bundle\nimport android.widget.Toast\nimport androidx.activity.ComponentActivity\nimport androidx.activity.compose.setContent\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.camera.compose.CameraXViewfinder\nimport androidx.camera.viewfinder.compose.MutableCoordinateTransformer\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.foundation.border\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.offset\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.layout.widthIn\nimport androidx.compose.foundation.layout.wrapContentSize\nimport androidx.compose.foundation.shape.CircleShape\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Scaffold\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.LaunchedEffect\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.geometry.Offset\nimport androidx.compose.ui.geometry.isSpecified\nimport androidx.compose.ui.geometry.takeOrElse\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.tooling.preview.Preview\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.round\nimport androidx.lifecycle.LifecycleOwner\nimport androidx.lifecycle.compose.LocalLifecycleOwner\nimport androidx.lifecycle.compose.collectAsStateWithLifecycle\nimport com.google.accompanist.permissions.ExperimentalPermissionsApi\nimport com.google.accompanist.permissions.isGranted\nimport com.google.accompanist.permissions.rememberPermissionState\nimport com.google.accompanist.permissions.shouldShowRationale\nimport com.serranoie.app.qrrounder.ui.theme.QRRounderTheme\nimport kotlinx.coroutines.delay\nimport java.util.UUID\n\nclass MainActivity : ComponentActivity() {\n    private val requestPermissionLauncher \u003d registerForActivityResult(\n        ActivityResultContracts.RequestPermission()\n    ) { granted -\u003e\n        if (!granted) {\n            Toast.makeText(this, \&quot;Camera permission denied\&quot;, Toast.LENGTH_LONG).show()\n            finish()\n        }\n    }\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        requestPermissionLauncher.launch(android.Manifest.permission.CAMERA)\n        setContent {\n            QRRounderTheme {\n                QRCodeScannerWithBottomSheet()\n            }\n        }\n    }\n}\n\n@OptIn(ExperimentalPermissionsApi::class)\n@Composable\nfun CameraPreviewScreen(\n    viewModel: CameraHandlerViewModel, modifier: Modifier \u003d Modifier\n) {\n    val cameraPermissionState \u003d rememberPermissionState(android.Manifest.permission.CAMERA)\n    if (cameraPermissionState.status.isGranted) {\n        CameraPreviewContent(viewModel, modifier)\n    } else {\n\n        Column(\n            modifier \u003d modifier\n                .fillMaxSize()\n                .wrapContentSize()\n                .widthIn(max \u003d 480.dp),\n            horizontalAlignment \u003d Alignment.CenterHorizontally\n        ) {\n            val textToShow \u003d if (cameraPermissionState.status.shouldShowRationale) {\n                // If the user has denied the permission but the rationale can be shown,\n                // then gently explain why the app requires this permission\n                \&quot;Whoops! Looks like we need your camera to work our magic!\&quot; + \&quot;Don\u0027t worry, we just wanna see your pretty face (and maybe some cats). \&quot; + \&quot;Grant us permission and let\u0027s get this party started!\&quot;\n            } else {\n                // If it\u0027s the first time the user lands on this feature, or the user\n                // doesn\u0027t want to be asked again for this permission, explain that the\n                // permission is required\n                \&quot;Hi there! We need your camera to work our magic! âœ¨\\n\&quot; + \&quot;Grant us permission and let\u0027s get this party started! \\uD83C\\uDF89\&quot;\n            }\n            Text(textToShow, textAlign \u003d TextAlign.Center)\n            Spacer(Modifier.height(16.dp))\n            Button(onClick \u003d { cameraPermissionState.launchPermissionRequest() }) {\n                Text(\&quot;Unleash the Camera!\&quot;)\n            }\n        }\n    }\n}\n\n@Composable\nfun CameraPreviewContent(\n    viewModel: CameraHandlerViewModel,\n    modifier: Modifier \u003d Modifier,\n    lifecycleOwner: LifecycleOwner \u003d LocalLifecycleOwner.current\n) {\n    val surfaceRequest by viewModel.surfaceRequest.collectAsStateWithLifecycle()\n    val context \u003d LocalContext.current\n    LaunchedEffect(lifecycleOwner) {\n        viewModel.bindToCamera(context.applicationContext, lifecycleOwner)\n    }\n\n    var autofocusRequest by remember { mutableStateOf(UUID.randomUUID() to Offset.Unspecified) }\n\n    val autofocusRequestId \u003d autofocusRequest.first\n    // Show the autofocus indicator if the offset is specified\n    val showAutofocusIndicator \u003d autofocusRequest.second.isSpecified\n    // Cache the initial coords for each autofocus request\n    val autofocusCoords \u003d remember(autofocusRequestId) { autofocusRequest.second }\n\n    // Queue hiding the request for each unique autofocus tap\n    if (showAutofocusIndicator) {\n        LaunchedEffect(autofocusRequestId) {\n            delay(1000)\n            // Clear the offset to finish the request and hide the indicator\n            autofocusRequest \u003d autofocusRequestId to Offset.Unspecified\n        }\n    }\n\n    surfaceRequest?.let { request -\u003e\n        val coordinateTransformer \u003d remember { MutableCoordinateTransformer() }\n        CameraXViewfinder(\n            surfaceRequest \u003d request,\n            coordinateTransformer \u003d coordinateTransformer,\n            modifier \u003d modifier.pointerInput(viewModel, coordinateTransformer) {\n                detectTapGestures { tapCoords -\u003e\n                    with(coordinateTransformer) {\n                        viewModel.tapToFocus(tapCoords.transform())\n                    }\n                    autofocusRequest \u003d UUID.randomUUID() to tapCoords\n                }\n            }\n        )\n\n        AnimatedVisibility(\n            visible \u003d showAutofocusIndicator,\n            enter \u003d fadeIn(),\n            exit \u003d fadeOut(),\n            modifier \u003d Modifier\n                .offset() { autofocusCoords.takeOrElse { Offset.Zero }.round() }\n                .offset((-24).dp, (-24).dp)\n        ) {\n            Spacer(Modifier.border(2.dp, Color.White, CircleShape).size(48.dp))\n        }\n    }\n}\n```\n\u003c/especially_relevant_code_snippet\u003e\n\n\u003cespecially_relevant_code_snippet\u003e\napp/src/main/java/com/serranoie/app/qrrounder/CameraHandlerViewModel.kt\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/CameraHandlerViewModel.kt\npackage com.serranoie.app.qrrounder\n\nimport android.content.Context\nimport androidx.camera.core.CameraControl\nimport androidx.camera.core.CameraSelector.DEFAULT_BACK_CAMERA\nimport androidx.camera.core.FocusMeteringAction\nimport androidx.camera.core.Preview\nimport androidx.camera.core.SurfaceOrientedMeteringPointFactory\nimport androidx.camera.core.SurfaceRequest\nimport androidx.camera.lifecycle.ProcessCameraProvider\nimport androidx.camera.lifecycle.awaitInstance\nimport androidx.compose.ui.geometry.Offset\nimport androidx.lifecycle.LifecycleOwner\nimport androidx.lifecycle.ViewModel\nimport kotlinx.coroutines.awaitCancellation\nimport kotlinx.coroutines.flow.MutableStateFlow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.update\n\nclass CameraHandlerViewModel : ViewModel() {\n\n    // used to set up a link between the Camera and your UI.\n    private val _surfaceRequest \u003d MutableStateFlow\u003cSurfaceRequest?\u003e(null)\n    val surfaceRequest: StateFlow\u003cSurfaceRequest?\u003e \u003d _surfaceRequest\n    private var surfaceMeteringPointFactory: SurfaceOrientedMeteringPointFactory? \u003d null\n    private var cameraControl: CameraControl? \u003d null\n\n    private val cameraPreviewUseCase \u003d Preview.Builder().build().apply {\n        setSurfaceProvider { newSurfaceRequest -\u003e\n            _surfaceRequest.update { newSurfaceRequest }\n            surfaceMeteringPointFactory \u003d SurfaceOrientedMeteringPointFactory(\n                newSurfaceRequest.resolution.width.toFloat(),\n                newSurfaceRequest.resolution.height.toFloat()\n            )\n        }\n    }\n\n    suspend fun bindToCamera(appContext: Context, lifecycleOwner: LifecycleOwner) {\n        val processCameraProvider \u003d ProcessCameraProvider.awaitInstance(appContext)\n        val camera \u003d processCameraProvider.bindToLifecycle(\n            lifecycleOwner, DEFAULT_BACK_CAMERA, cameraPreviewUseCase\n        )\n        cameraControl \u003d camera.cameraControl\n\n        // Cancellation signals we\u0027re done with the camera\n        try {\n            awaitCancellation()\n        } finally {\n            processCameraProvider.unbindAll()\n            cameraControl \u003d null\n        }\n    }\n\n    fun tapToFocus(tapCoords: Offset) {\n        val point \u003d surfaceMeteringPointFactory?.createPoint(tapCoords.x, tapCoords.y)\n        if (point !\u003d null) {\n            val meteringAction \u003d FocusMeteringAction.Builder(point).build()\n            cameraControl?.startFocusAndMetering(meteringAction)\n        }\n    }\n}\n```\n\u003c/especially_relevant_code_snippet\u003e\n\u003c/additional_data\u003e\n\n\n\u003cuser_query\u003e\nHow could you add the TouchToFocus into the QrCodeScannerWithButtonSheet to display it when the user touches the display to show an indicator that the camera focused?\n\u003c/user_query\u003e&quot;},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;# Adding Touch-to-Focus to QRCodeScannerWithBottomSheet\n\nI\u0027ll add the touch-to-focus feature with a visual indicator to your QR code scanner. Here are the changes needed:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun QRCodeScannerWithBottomSheet() {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    val clipboardManager \u003d context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager\n\n    // Add states for touch-to-focus\n    var tapCoordinates by remember { mutableStateOf\u003cOffset?\u003e(null) }\n    val showFocusIndicator \u003d tapCoordinates !\u003d null\n    \n    // Controls the focus indicator visibility\n    LaunchedEffect(tapCoordinates) {\n        if (tapCoordinates !\u003d null) {\n            delay(1000)\n            tapCoordinates \u003d null\n        }\n    }\n\n    val sheetState \u003d rememberModalBottomSheetState(skipPartiallyExpanded \u003d true)\n    var scannedCode by remember { mutableStateOf\u003cString?\u003e(null) }\n    var showSheet by remember { mutableStateOf(false) }\n    \n    // Bottom sheet implementation (unchanged)\n    if (showSheet \u0026\u0026 scannedCode !\u003d null) {\n        ModalBottomSheet(\n            onDismissRequest \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            }, sheetState \u003d sheetState\n        ) {\n            // Bottom sheet content (unchanged)\n            BottomSheetContent(scannedCode \u003d scannedCode.orEmpty(), onCopy \u003d {\n                // Existing copy code...\n            }, onShare \u003d {\n                // Existing share code...\n            }, onClose \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            })\n        }\n    }\n\n    // Camera preview with touch-to-focus\n    Box(modifier \u003d Modifier.fillMaxSize()) {\n        AndroidView(\n            factory \u003d { ctx -\u003e\n                val previewView \u003d PreviewView(ctx)\n                val cameraProviderFuture \u003d ProcessCameraProvider.getInstance(ctx)\n                \n                cameraProviderFuture.addListener({\n                    val cameraProvider \u003d cameraProviderFuture.get()\n                    val preview \u003d Preview.Builder().build().apply {\n                        setSurfaceProvider(previewView.surfaceProvider)\n                    }\n                    \n                    val analyzer \u003d ImageAnalysis.Builder()\n                        .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST).build().also {\n                            it.setAnalyzer(\n                                ContextCompat.getMainExecutor(ctx), QRCodeAnalyzer { qrCode -\u003e\n                                    if (!showSheet) {\n                                        scannedCode \u003d qrCode\n                                        showSheet \u003d true\n                                    }\n                                })\n                        }\n                        \n                    cameraProvider.unbindAll()\n                    val camera \u003d cameraProvider.bindToLifecycle(\n                        lifecycleOwner, CameraSelector.DEFAULT_BACK_CAMERA, preview, analyzer\n                    )\n                    \n                    // Store camera control for focus\n                    previewView.setOnTouchListener { _, event -\u003e\n                        if (event.action \u003d\u003d MotionEvent.ACTION_DOWN) {\n                            val meteringPointFactory \u003d SurfaceOrientedMeteringPointFactory(\n                                previewView.width.toFloat(),\n                                previewView.height.toFloat()\n                            )\n                            val meteringPoint \u003d meteringPointFactory.createPoint(event.x, event.y)\n                            val focusAction \u003d FocusMeteringAction.Builder(meteringPoint).build()\n                            \n                            camera.cameraControl.startFocusAndMetering(focusAction)\n                            tapCoordinates \u003d Offset(event.x, event.y)\n                            return@setOnTouchListener true\n                        }\n                        false\n                    }\n                    \n                    previewView\n                }, ContextCompat.getMainExecutor(ctx))\n                \n                previewView\n            }, \n            modifier \u003d Modifier.fillMaxSize()\n        )\n        \n        // Focus indicator\n        AnimatedVisibility(\n            visible \u003d showFocusIndicator,\n            enter \u003d fadeIn(),\n            exit \u003d fadeOut(),\n            modifier \u003d Modifier.fillMaxSize()\n        ) {\n            Box(modifier \u003d Modifier.fillMaxSize()) {\n                tapCoordinates?.let { offset -\u003e\n                    Spacer(\n                        modifier \u003d Modifier\n                            .offset { IntOffset(offset.x.toInt() - 24.dp.toPx().toInt(), offset.y.toInt() - 24.dp.toPx().toInt()) }\n                            .size(48.dp)\n                            .border(2.dp, Color.White, CircleShape)\n                    )\n                }\n            }\n        }\n    }\n}\n```\n\n## Required Imports\n\nYou\u0027ll need to add these imports:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\nimport android.view.MotionEvent\nimport androidx.camera.core.CameraSelector\nimport androidx.camera.core.FocusMeteringAction\nimport androidx.camera.core.SurfaceOrientedMeteringPointFactory\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.foundation.border\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.shape.CircleShape\nimport androidx.compose.ui.geometry.Offset\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.unit.IntOffset\nimport androidx.compose.ui.unit.dp\nimport kotlinx.coroutines.delay\n```\n\n## Explanation\n\n1. I added state management for touch coordinates with `tapCoordinates` and logic to automatically hide the focus indicator after 1 second.\n\n2. Changed the layout to use a `Box` as the root container so we can overlay the focus indicator on top of the camera preview.\n\n3. Added touch handling to the previewView with `setOnTouchListener` to:\n   - Create a metering point where the user touched\n   - Start camera focusing at that point\n   - Update the tap coordinates state to show the indicator\n\n4. Added an `AnimatedVisibility` component with a circular border to show the focus indicator at the tap position.\n\nThe implementation follows the same pattern as your `CameraPreviewContent` but is integrated directly into the QR scanner component.&quot;},{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;\u003cuser_query\u003e\ncan you refactor the code?\n\u003c/user_query\u003e&quot;},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;# Refactored QRCodeScannerWithBottomSheet\n\nI\u0027ll refactor the code to make it more modular and maintainable. Here\u0027s the improved version:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun QRCodeScannerWithBottomSheet() {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    val clipboardManager \u003d context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager\n\n    // State management\n    var tapCoordinates by remember { mutableStateOf\u003cOffset?\u003e(null) }\n    var scannedCode by remember { mutableStateOf\u003cString?\u003e(null) }\n    var showSheet by remember { mutableStateOf(false) }\n    val sheetState \u003d rememberModalBottomSheetState(skipPartiallyExpanded \u003d true)\n\n    // Handle focus indicator visibility timeout\n    LaunchedEffect(tapCoordinates) {\n        if (tapCoordinates !\u003d null) {\n            delay(1000)\n            tapCoordinates \u003d null\n        }\n    }\n\n    // Show bottom sheet when QR code is detected\n    if (showSheet \u0026\u0026 scannedCode !\u003d null) {\n        QrCodeBottomSheet(\n            scannedCode \u003d scannedCode.orEmpty(),\n            sheetState \u003d sheetState,\n            onDismiss \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            },\n            onCopy \u003d {\n                clipboardManager.setPrimaryClip(ClipData.newPlainText(\&quot;QR Code\&quot;, scannedCode))\n                Toast.makeText(context, \&quot;Copied to clipboard\&quot;, Toast.LENGTH_SHORT).show()\n            },\n            onShare \u003d {\n                val intent \u003d Intent(Intent.ACTION_SEND).apply {\n                    type \u003d \&quot;text/plain\&quot;\n                    putExtra(Intent.EXTRA_TEXT, scannedCode)\n                }\n                context.startActivity(Intent.createChooser(intent, \&quot;Share QR Code\&quot;))\n            }\n        )\n    }\n\n    Box(modifier \u003d Modifier.fillMaxSize()) {\n        // Camera preview\n        CameraPreview(\n            onQrCodeScanned \u003d { code -\u003e\n                if (!showSheet) {\n                    scannedCode \u003d code\n                    showSheet \u003d true\n                }\n            },\n            onFocusTap \u003d { coordinates -\u003e\n                tapCoordinates \u003d coordinates\n            }\n        )\n        \n        // Focus indicator overlay\n        FocusIndicator(\n            tapCoordinates \u003d tapCoordinates,\n            showIndicator \u003d tapCoordinates !\u003d null\n        )\n    }\n}\n\n@Composable\nprivate fun CameraPreview(\n    onQrCodeScanned: (String) -\u003e Unit,\n    onFocusTap: (Offset) -\u003e Unit\n) {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    \n    AndroidView(\n        factory \u003d { ctx -\u003e\n            val previewView \u003d PreviewView(ctx)\n            val cameraProviderFuture \u003d ProcessCameraProvider.getInstance(ctx)\n            \n            cameraProviderFuture.addListener({\n                val cameraProvider \u003d cameraProviderFuture.get()\n                val preview \u003d Preview.Builder().build().apply {\n                    setSurfaceProvider(previewView.surfaceProvider)\n                }\n                \n                val analyzer \u003d ImageAnalysis.Builder()\n                    .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)\n                    .build()\n                    .also {\n                        it.setAnalyzer(\n                            ContextCompat.getMainExecutor(ctx), \n                            QRCodeAnalyzer(onQrCodeScanned)\n                        )\n                    }\n                    \n                cameraProvider.unbindAll()\n                val camera \u003d cameraProvider.bindToLifecycle(\n                    lifecycleOwner, \n                    CameraSelector.DEFAULT_BACK_CAMERA,\n                    preview, \n                    analyzer\n                )\n                \n                setupTouchToFocus(previewView, camera, onFocusTap)\n                \n                previewView\n            }, ContextCompat.getMainExecutor(ctx))\n            \n            previewView\n        }, \n        modifier \u003d Modifier.fillMaxSize()\n    )\n}\n\nprivate fun setupTouchToFocus(\n    previewView: PreviewView,\n    camera: androidx.camera.core.Camera,\n    onFocusTap: (Offset) -\u003e Unit\n) {\n    previewView.setOnTouchListener { _, event -\u003e\n        if (event.action \u003d\u003d MotionEvent.ACTION_DOWN) {\n            val meteringPointFactory \u003d SurfaceOrientedMeteringPointFactory(\n                previewView.width.toFloat(),\n                previewView.height.toFloat()\n            )\n            \n            val meteringPoint \u003d meteringPointFactory.createPoint(event.x, event.y)\n            val focusAction \u003d FocusMeteringAction.Builder(meteringPoint).build()\n            \n            camera.cameraControl.startFocusAndMetering(focusAction)\n            onFocusTap(Offset(event.x, event.y))\n            return@setOnTouchListener true\n        }\n        false\n    }\n}\n\n@Composable\nprivate fun FocusIndicator(\n    tapCoordinates: Offset?,\n    showIndicator: Boolean\n) {\n    AnimatedVisibility(\n        visible \u003d showIndicator,\n        enter \u003d fadeIn(),\n        exit \u003d fadeOut(),\n        modifier \u003d Modifier.fillMaxSize()\n    ) {\n        Box(modifier \u003d Modifier.fillMaxSize()) {\n            tapCoordinates?.let { offset -\u003e\n                Spacer(\n                    modifier \u003d Modifier\n                        .offset { \n                            IntOffset(\n                                offset.x.toInt() - 24.dp.toPx().toInt(),\n                                offset.y.toInt() - 24.dp.toPx().toInt()\n                            ) \n                        }\n                        .size(48.dp)\n                        .border(2.dp, Color.White, CircleShape)\n                )\n            }\n        }\n    }\n}\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nprivate fun QrCodeBottomSheet(\n    scannedCode: String,\n    sheetState: SheetState,\n    onDismiss: () -\u003e Unit,\n    onCopy: () -\u003e Unit,\n    onShare: () -\u003e Unit\n) {\n    ModalBottomSheet(\n        onDismissRequest \u003d onDismiss,\n        sheetState \u003d sheetState\n    ) {\n        BottomSheetContent(\n            scannedCode \u003d scannedCode,\n            onCopy \u003d onCopy,\n            onShare \u003d onShare,\n            onClose \u003d onDismiss\n        )\n    }\n}\n```\n\n## Additional Import Required\n\n```kotlin\nimport androidx.compose.material3.SheetState\n```\n\n## Improvements Made\n\n1. **Modular Components**: Split the code into focused composable functions with clear responsibilities:\n   - `CameraPreview`: Handles camera setup and QR code analysis\n   - `FocusIndicator`: Displays the focus ring when tapping\n   - `QrCodeBottomSheet`: Contains the bottom sheet UI and functionality\n\n2. **Extracted Helper Functions**:\n   - Created `setupTouchToFocus` to isolate touch handling logic\n   - Made the event handlers more reusable with lambda callbacks\n\n3. **Improved State Management**:\n   - Cleaned up the state variables organization\n   - Used more descriptive parameter names for better readability\n\n4. **Cleaner Event Handling**:\n   - Used callback functions to simplify the flow of events between components\n   - Better separation of concerns between UI and behavior\n\nThis refactoring makes the code more maintainable, easier to understand, and simpler to modify in the future.&quot;},{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;\u003cuser_query\u003e\nNow on top of that preview can you integrate a simple outlined square as a guide on where to scan the QR file itsel?\n\u003c/user_query\u003e&quot;},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;# Adding a QR Code Scanning Guide\n\nI\u0027ll add an outlined square guide overlay to help users position QR codes for scanning. Here\u0027s the implementation:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun QRCodeScannerWithBottomSheet() {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    val clipboardManager \u003d context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager\n\n    // State management\n    var tapCoordinates by remember { mutableStateOf\u003cOffset?\u003e(null) }\n    var scannedCode by remember { mutableStateOf\u003cString?\u003e(null) }\n    var showSheet by remember { mutableStateOf(false) }\n    val sheetState \u003d rememberModalBottomSheetState(skipPartiallyExpanded \u003d true)\n\n    // Handle focus indicator visibility timeout\n    LaunchedEffect(tapCoordinates) {\n        if (tapCoordinates !\u003d null) {\n            delay(1000)\n            tapCoordinates \u003d null\n        }\n    }\n\n    // Show bottom sheet when QR code is detected\n    if (showSheet \u0026\u0026 scannedCode !\u003d null) {\n        QrCodeBottomSheet(\n            scannedCode \u003d scannedCode.orEmpty(),\n            sheetState \u003d sheetState,\n            onDismiss \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            },\n            onCopy \u003d {\n                clipboardManager.setPrimaryClip(ClipData.newPlainText(\&quot;QR Code\&quot;, scannedCode))\n                Toast.makeText(context, \&quot;Copied to clipboard\&quot;, Toast.LENGTH_SHORT).show()\n            },\n            onShare \u003d {\n                val intent \u003d Intent(Intent.ACTION_SEND).apply {\n                    type \u003d \&quot;text/plain\&quot;\n                    putExtra(Intent.EXTRA_TEXT, scannedCode)\n                }\n                context.startActivity(Intent.createChooser(intent, \&quot;Share QR Code\&quot;))\n            }\n        )\n    }\n\n    Box(modifier \u003d Modifier.fillMaxSize()) {\n        // Camera preview\n        CameraPreview(\n            onQrCodeScanned \u003d { code -\u003e\n                if (!showSheet) {\n                    scannedCode \u003d code\n                    showSheet \u003d true\n                }\n            },\n            onFocusTap \u003d { coordinates -\u003e\n                tapCoordinates \u003d coordinates\n            }\n        )\n        \n        // QR code scanning guide overlay\n        QrCodeScanGuide()\n        \n        // Focus indicator overlay\n        FocusIndicator(\n            tapCoordinates \u003d tapCoordinates,\n            showIndicator \u003d tapCoordinates !\u003d null\n        )\n    }\n}\n\n// Other existing components remain unchanged...\n\n@Composable\nprivate fun QrCodeScanGuide() {\n    Box(\n        modifier \u003d Modifier\n            .fillMaxSize(),\n        contentAlignment \u003d Alignment.Center\n    ) {\n        // Scanner guide frame\n        Box(\n            modifier \u003d Modifier\n                .size(250.dp)\n                .border(\n                    width \u003d 3.dp,\n                    color \u003d Color.White.copy(alpha \u003d 0.8f),\n                    shape \u003d RoundedCornerShape(12.dp)\n                )\n        ) {\n            // Corner elements for the scanning frame\n            // Top-Left corner\n            Box(\n                modifier \u003d Modifier\n                    .offset((-2).dp, (-2).dp)\n                    .size(24.dp, 4.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n            Box(\n                modifier \u003d Modifier\n                    .offset((-2).dp, (-2).dp)\n                    .size(4.dp, 24.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n\n            // Top-Right corner\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.TopEnd)\n                    .offset(2.dp, (-2).dp)\n                    .size(24.dp, 4.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.TopEnd)\n                    .offset((-2).dp, (-2).dp)\n                    .size(4.dp, 24.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n\n            // Bottom-Left corner\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.BottomStart)\n                    .offset((-2).dp, 2.dp)\n                    .size(24.dp, 4.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.BottomStart)\n                    .offset((-2).dp, (-22).dp)\n                    .size(4.dp, 24.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n\n            // Bottom-Right corner\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.BottomEnd)\n                    .offset((-22).dp, 2.dp)\n                    .size(24.dp, 4.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n            Box(\n                modifier \u003d Modifier\n                    .align(Alignment.BottomEnd)\n                    .offset((-2).dp, (-22).dp)\n                    .size(4.dp, 24.dp)\n                    .background(Color(0xFF4CAF50))\n            )\n        }\n        \n        // Optional: Add a text instruction below the frame\n        Text(\n            text \u003d \&quot;Position QR code within the frame\&quot;,\n            color \u003d Color.White,\n            fontSize \u003d 14.sp,\n            fontWeight \u003d FontWeight.Medium,\n            modifier \u003d Modifier\n                .align(Alignment.BottomCenter)\n                .padding(bottom \u003d 100.dp)\n                .background(Color.Black.copy(alpha \u003d 0.5f), RoundedCornerShape(4.dp))\n                .padding(horizontal \u003d 16.dp, vertical \u003d 8.dp)\n        )\n    }\n}\n```\n\n## Additional Required Imports\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material3.Text\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.unit.sp\n```\n\n## Explanation of the Scanner Guide\n\n1. **Centered QR Frame**: A 250.dp square box with a white border and rounded corners that serves as a visual guide for users to position their QR code.\n\n2. **Corner Markers**: Green L-shaped corner indicators to help draw attention to the scanning area. These provide a more professional \&quot;scanner\&quot; look that helps users immediately understand where to position the code.\n\n3. **Instruction Text**: A semi-transparent label at the bottom that provides explicit instructions for the user.\n\n4. **Visual Hierarchy**: \n   - The QR frame is layered between the camera preview and the focus indicator\n   - This ensures the frame is always visible but won\u0027t interfere with the focus indicator\n\nThe scanner guide is purely visual and doesn\u0027t affect the actual scanning functionality - the QR code can still be detected anywhere in the camera view. However, by providing this guide, users will intuitively position the code in the optimal position for faster scanning.\n\nYou can adjust the size, colors, and corner styles to match your app\u0027s design language. The current implementation uses a Material Design-inspired green accent color (0xFF4CAF50) for the corner highlights.&quot;},{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;\u003cadditional_data\u003e\n\u003cespecially_relevant_code_snippet\u003e\napp/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\npackage com.serranoie.app.qrrounder\n\nimport android.content.ClipData\nimport android.content.ClipboardManager\nimport android.content.Context\nimport android.content.Intent\nimport android.view.MotionEvent\nimport android.widget.Toast\nimport androidx.camera.core.CameraSelector\nimport androidx.camera.core.FocusMeteringAction\nimport androidx.camera.core.ImageAnalysis\nimport androidx.camera.core.Preview\nimport androidx.camera.core.SurfaceOrientedMeteringPointFactory\nimport androidx.camera.lifecycle.ProcessCameraProvider\nimport androidx.camera.view.PreviewView\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.border\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.offset\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.shape.CircleShape\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material3.ExperimentalMaterial3Api\nimport androidx.compose.material3.ModalBottomSheet\nimport androidx.compose.material3.SheetState\nimport androidx.compose.material3.Text\nimport androidx.compose.material3.rememberModalBottomSheetState\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.LaunchedEffect\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.geometry.Offset\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.unit.IntOffset\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport androidx.compose.ui.viewinterop.AndroidView\nimport androidx.core.content.ContextCompat\nimport androidx.lifecycle.compose.LocalLifecycleOwner\nimport kotlinx.coroutines.delay\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun QRCodeScannerWithBottomSheet() {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    val clipboardManager \u003d context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager\n\n    // State management\n    var tapCoordinates by remember { mutableStateOf\u003cOffset?\u003e(null) }\n    var scannedCode by remember { mutableStateOf\u003cString?\u003e(null) }\n    var showSheet by remember { mutableStateOf(false) }\n    val sheetState \u003d rememberModalBottomSheetState(skipPartiallyExpanded \u003d true)\n\n    // Handle focus indicator visibility timeout\n    LaunchedEffect(tapCoordinates) {\n        if (tapCoordinates !\u003d null) {\n            delay(1000)\n            tapCoordinates \u003d null\n        }\n    }\n\n    // Show bottom sheet when QR code is detected\n    if (showSheet \u0026\u0026 scannedCode !\u003d null) {\n        QrCodeBottomSheet(\n            scannedCode \u003d scannedCode.orEmpty(),\n            sheetState \u003d sheetState,\n            onDismiss \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            },\n            onCopy \u003d {\n                clipboardManager.setPrimaryClip(ClipData.newPlainText(\&quot;QR Code\&quot;, scannedCode))\n                Toast.makeText(context, \&quot;Copied to clipboard\&quot;, Toast.LENGTH_SHORT).show()\n            },\n            onShare \u003d {\n                val intent \u003d Intent(Intent.ACTION_SEND).apply {\n                    type \u003d \&quot;text/plain\&quot;\n                    putExtra(Intent.EXTRA_TEXT, scannedCode)\n                }\n                context.startActivity(Intent.createChooser(intent, \&quot;Share QR Code\&quot;))\n            }\n        )\n    }\n\n    Box(modifier \u003d Modifier.fillMaxSize()) {\n        // Camera preview\n        CameraPreview(\n            onQrCodeScanned \u003d { code -\u003e\n                if (!showSheet) {\n                    scannedCode \u003d code\n                    showSheet \u003d true\n                }\n            },\n            onFocusTap \u003d { coordinates -\u003e\n                tapCoordinates \u003d coordinates\n            }\n        )\n\n        // QR code scanning guide overlay\n        QrCodeScanGuide()\n\n        // Focus indicator overlay\n        FocusIndicator(\n            tapCoordinates \u003d tapCoordinates,\n            showIndicator \u003d tapCoordinates !\u003d null\n        )\n    }\n}\n\n@Composable\nprivate fun CameraPreview(\n    onQrCodeScanned: (String) -\u003e Unit,\n    onFocusTap: (Offset) -\u003e Unit\n) {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n\n    AndroidView(\n        factory \u003d { ctx -\u003e\n            val previewView \u003d PreviewView(ctx)\n            val cameraProviderFuture \u003d ProcessCameraProvider.getInstance(ctx)\n\n            cameraProviderFuture.addListener({\n                val cameraProvider \u003d cameraProviderFuture.get()\n                val preview \u003d Preview.Builder().build().apply {\n                    setSurfaceProvider(previewView.surfaceProvider)\n                }\n\n                val analyzer \u003d ImageAnalysis.Builder()\n                    .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)\n                    .build()\n                    .also {\n                        it.setAnalyzer(\n                            ContextCompat.getMainExecutor(ctx),\n                            QRCodeAnalyzer(onQrCodeScanned)\n                        )\n                    }\n\n                cameraProvider.unbindAll()\n                val camera \u003d cameraProvider.bindToLifecycle(\n                    lifecycleOwner,\n                    CameraSelector.DEFAULT_BACK_CAMERA,\n                    preview,\n                    analyzer\n                )\n\n                setupTouchToFocus(previewView, camera, onFocusTap)\n\n                previewView\n            }, ContextCompat.getMainExecutor(ctx))\n\n            previewView\n        },\n        modifier \u003d Modifier.fillMaxSize()\n    )\n}\n\nprivate fun setupTouchToFocus(\n    previewView: PreviewView,\n    camera: androidx.camera.core.Camera,\n    onFocusTap: (Offset) -\u003e Unit\n) {\n    previewView.setOnTouchListener { _, event -\u003e\n        if (event.action \u003d\u003d MotionEvent.ACTION_DOWN) {\n            val meteringPointFactory \u003d SurfaceOrientedMeteringPointFactory(\n                previewView.width.toFloat(),\n                previewView.height.toFloat()\n            )\n\n            val meteringPoint \u003d meteringPointFactory.createPoint(event.x, event.y)\n            val focusAction \u003d FocusMeteringAction.Builder(meteringPoint).build()\n\n            camera.cameraControl.startFocusAndMetering(focusAction)\n            onFocusTap(Offset(event.x, event.y))\n            return@setOnTouchListener true\n        }\n        false\n    }\n}\n\n@Composable\nprivate fun FocusIndicator(\n    tapCoordinates: Offset?,\n    showIndicator: Boolean\n) {\n    AnimatedVisibility(\n        visible \u003d showIndicator,\n        enter \u003d fadeIn(),\n        exit \u003d fadeOut(),\n        modifier \u003d Modifier.fillMaxSize()\n    ) {\n        Box(modifier \u003d Modifier.fillMaxSize()) {\n            tapCoordinates?.let { offset -\u003e\n                Spacer(\n                    modifier \u003d Modifier\n                        .offset {\n                            IntOffset(\n                                offset.x.toInt() - 24.dp.toPx().toInt(),\n                                offset.y.toInt() - 24.dp.toPx().toInt()\n                            )\n                        }\n                        .size(48.dp)\n                        .border(2.dp, Color.White, CircleShape)\n                )\n            }\n        }\n    }\n}\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nprivate fun QrCodeBottomSheet(\n    scannedCode: String,\n    sheetState: SheetState,\n    onDismiss: () -\u003e Unit,\n    onCopy: () -\u003e Unit,\n    onShare: () -\u003e Unit\n) {\n    ModalBottomSheet(\n        onDismissRequest \u003d onDismiss,\n        sheetState \u003d sheetState\n    ) {\n        BottomSheetContent(\n            scannedCode \u003d scannedCode,\n            onCopy \u003d onCopy,\n            onShare \u003d onShare,\n            onClose \u003d onDismiss\n        )\n    }\n}\n\n@Composable\nprivate fun QrCodeScanGuide() {\n    Box(\n        modifier \u003d Modifier\n            .fillMaxSize(),\n        contentAlignment \u003d Alignment.Center\n    ) {\n        // Scanner guide frame\n        Box(\n            modifier \u003d Modifier\n                .size(250.dp)\n                .border(\n                    width \u003d 3.dp,\n                    color \u003d Color.White.copy(alpha \u003d 0.8f),\n                    shape \u003d RoundedCornerShape(12.dp)\n                )\n        )\n        // Optional: Add a text instruction below the frame\n        Box(\n            modifier \u003d Modifier\n                .align(Alignment.BottomCenter)\n                .padding(bottom \u003d 100.dp)\n                .background(Color.Black.copy(alpha \u003d 0.5f), RoundedCornerShape(4.dp))\n                .padding(horizontal \u003d 16.dp, vertical \u003d 8.dp)\n        ) {\n            Text(\n                text \u003d \&quot;Position QR code within the frame\&quot;,\n                color \u003d Color.White,\n                fontSize \u003d 14.sp,\n                fontWeight \u003d FontWeight.Bold,\n                modifier \u003d Modifier\n            )\n        }\n    }\n}\n```\n\u003c/especially_relevant_code_snippet\u003e\n\u003c/additional_data\u003e\n\n\n\u003cuser_query\u003e\nCurrently there is the simple square and the text as instructions, how can I make that all the preview apart from the square at the middle stars with a darker background, meaning that it shows a simple Box or column with a black background and an opacity of 55%?\n\u003c/user_query\u003e&quot;},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;# Adding Darkened Overlay with Transparent Scanner Window\n\nI\u0027ll enhance the QR scanner guide by adding a semi-transparent dark overlay everywhere except for the scanning frame. This will help focus the user\u0027s attention on the scanning area.\n\nHere\u0027s how to implement it:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n@Composable\nprivate fun QrCodeScanGuide() {\n    val scannerSize \u003d 250.dp\n    \n    Box(\n        modifier \u003d Modifier.fillMaxSize(),\n        contentAlignment \u003d Alignment.Center\n    ) {\n        // Semi-transparent overlay covering the entire screen except the scanner window\n        Canvas(modifier \u003d Modifier.fillMaxSize()) {\n            // Convert dimensions to pixels for the Canvas\n            val scannerSizePx \u003d scannerSize.toPx()\n            val centerX \u003d size.width / 2\n            val centerY \u003d size.height / 2\n            \n            val rectSize \u003d Size(size.width, size.height)\n            \n            // Draw the semi-transparent dark overlay\n            drawRect(\n                color \u003d Color.Black.copy(alpha \u003d 0.55f),\n                size \u003d rectSize\n            )\n            \n            // Create a clear window by using the \&quot;clear\&quot; blend mode\n            drawRoundRect(\n                color \u003d Color.Transparent,\n                topLeft \u003d Offset(\n                    centerX - scannerSizePx / 2,\n                    centerY - scannerSizePx / 2\n                ),\n                size \u003d Size(scannerSizePx, scannerSizePx),\n                cornerRadius \u003d CornerRadius(12.dp.toPx(), 12.dp.toPx()),\n                blendMode \u003d BlendMode.Clear\n            )\n        }\n        \n        // Scanner guide frame (border)\n        Box(\n            modifier \u003d Modifier\n                .size(scannerSize)\n                .border(\n                    width \u003d 3.dp,\n                    color \u003d Color.White.copy(alpha \u003d 0.8f),\n                    shape \u003d RoundedCornerShape(12.dp)\n                )\n        )\n        \n        // Instruction text\n        Box(\n            modifier \u003d Modifier\n                .align(Alignment.BottomCenter)\n                .padding(bottom \u003d 100.dp)\n                .background(Color.Black.copy(alpha \u003d 0.5f), RoundedCornerShape(4.dp))\n                .padding(horizontal \u003d 16.dp, vertical \u003d 8.dp)\n        ) {\n            Text(\n                text \u003d \&quot;Position QR code within the frame\&quot;,\n                color \u003d Color.White,\n                fontSize \u003d 14.sp,\n                fontWeight \u003d FontWeight.Bold\n            )\n        }\n    }\n}\n```\n\n## Additional Required Imports\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\nimport androidx.compose.ui.graphics.BlendMode\nimport androidx.compose.ui.graphics.drawscope.drawIntoCanvas\nimport androidx.compose.ui.graphics.nativeCanvas\nimport androidx.compose.ui.graphics.drawscope.DrawScope\nimport androidx.compose.ui.graphics.Size\nimport androidx.compose.ui.graphics.CornerRadius\nimport androidx.compose.ui.graphics.drawscope.Stroke\nimport androidx.compose.ui.graphics.PathEffect\nimport androidx.compose.foundation.Canvas\n```\n\n## Explanation\n\n1. **Canvas Drawing Approach**: \n   - I\u0027m using a `Canvas` composable for drawing the overlay with a clear \&quot;punch-hole\&quot; for the scanner window.\n   - This approach gives precise control over the shape and appearance.\n\n2. **Semi-transparent Overlay**:\n   - First draws a black rectangle with 55% opacity covering the entire screen.\n   - Then creates a transparent \&quot;window\&quot; in the center using the `BlendMode.Clear` blend mode.\n\n3. **Scanner Border**:\n   - Maintains the white border around the scanning area.\n   - Uses the same size and position as the transparent window.\n\n4. **Instruction Text**:\n   - Kept at the same position below the scanner frame.\n\n5. **Variables for Consistency**:\n   - Added a `scannerSize` variable to ensure the window size is consistent between the overlay and border.\n\nThis implementation creates a professional, focused scanning experience by dimming the surroundings while keeping the scanning area fully visible. The effect guides the user\u0027s attention directly to where they should position the QR code, which improves usability and scanning success rates.\n\nThe 55% opacity provides enough darkening to create contrast while still allowing users to see the context of what they\u0027re scanning.&quot;},{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;\u003cuser_query\u003e\nCan you make a screen or composable to show on launch on the main activity that shows a Text Input, a button to generate the QR from the text input and then a button that says camera to launc the QrScannerScreen?\n\u003c/user_query\u003e&quot;},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;# Creating a Home Screen with QR Generate and Scan Options\n\nLet\u0027s create a new home screen composable that displays on launch with text input for generating QR codes and a button to launch the scanner. Here\u0027s the implementation:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/HomeScreen.kt\npackage com.serranoie.app.qrrounder\n\nimport android.graphics.Bitmap\nimport androidx.compose.foundation.Image\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.rememberScrollState\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.foundation.text.KeyboardActions\nimport androidx.compose.foundation.text.KeyboardOptions\nimport androidx.compose.foundation.verticalScroll\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.CameraAlt\nimport androidx.compose.material.icons.filled.QrCode\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.ButtonDefaults\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.CardDefaults\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedTextField\nimport androidx.compose.material3.Surface\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clip\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.graphics.asImageBitmap\nimport androidx.compose.ui.platform.LocalFocusManager\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.text.input.ImeAction\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport com.google.zxing.BarcodeFormat\nimport com.google.zxing.EncodeHintType\nimport com.google.zxing.qrcode.QRCodeWriter\nimport com.google.zxing.qrcode.decoder.ErrorCorrectionLevel\n\n@Composable\nfun HomeScreen(\n    onScanClicked: () -\u003e Unit\n) {\n    var textInput by remember { mutableStateOf(\&quot;\&quot;) }\n    var generatedQRBitmap by remember { mutableStateOf\u003cBitmap?\u003e(null) }\n    val focusManager \u003d LocalFocusManager.current\n\n    Surface(\n        modifier \u003d Modifier.fillMaxSize(),\n        color \u003d MaterialTheme.colorScheme.background\n    ) {\n        Column(\n            modifier \u003d Modifier\n                .fillMaxSize()\n                .padding(16.dp)\n                .verticalScroll(rememberScrollState()),\n            horizontalAlignment \u003d Alignment.CenterHorizontally,\n            verticalArrangement \u003d Arrangement.spacedBy(16.dp)\n        ) {\n            // App title\n            Text(\n                text \u003d \&quot;QR Rounder\&quot;,\n                fontSize \u003d 28.sp,\n                fontWeight \u003d FontWeight.Bold,\n                color \u003d MaterialTheme.colorScheme.primary,\n                textAlign \u003d TextAlign.Center,\n                modifier \u003d Modifier.padding(vertical \u003d 24.dp)\n            )\n            \n            // App description\n            Text(\n                text \u003d \&quot;Generate or scan QR codes with ease\&quot;,\n                fontSize \u003d 16.sp,\n                textAlign \u003d TextAlign.Center,\n                color \u003d MaterialTheme.colorScheme.onSurfaceVariant\n            )\n            \n            Spacer(modifier \u003d Modifier.height(24.dp))\n            \n            // Input section\n            Card(\n                modifier \u003d Modifier.fillMaxWidth(),\n                elevation \u003d CardDefaults.cardElevation(defaultElevation \u003d 4.dp),\n                colors \u003d CardDefaults.cardColors(containerColor \u003d MaterialTheme.colorScheme.surface)\n            ) {\n                Column(\n                    modifier \u003d Modifier\n                        .fillMaxWidth()\n                        .padding(16.dp),\n                    horizontalAlignment \u003d Alignment.CenterHorizontally\n                ) {\n                    Text(\n                        text \u003d \&quot;Generate QR Code\&quot;,\n                        fontWeight \u003d FontWeight.Medium,\n                        fontSize \u003d 18.sp,\n                        color \u003d MaterialTheme.colorScheme.onSurface\n                    )\n                    \n                    Spacer(modifier \u003d Modifier.height(16.dp))\n                    \n                    OutlinedTextField(\n                        value \u003d textInput,\n                        onValueChange \u003d { textInput \u003d it },\n                        modifier \u003d Modifier.fillMaxWidth(),\n                        label \u003d { Text(\&quot;Enter text or URL\&quot;) },\n                        keyboardOptions \u003d KeyboardOptions(imeAction \u003d ImeAction.Done),\n                        keyboardActions \u003d KeyboardActions(\n                            onDone \u003d { \n                                focusManager.clearFocus() \n                                if (textInput.isNotEmpty()) {\n                                    generatedQRBitmap \u003d generateQRCode(textInput)\n                                }\n                            }\n                        ),\n                        singleLine \u003d false,\n                        maxLines \u003d 4\n                    )\n                    \n                    Spacer(modifier \u003d Modifier.height(16.dp))\n                    \n                    Button(\n                        onClick \u003d { \n                            focusManager.clearFocus()\n                            if (textInput.isNotEmpty()) {\n                                generatedQRBitmap \u003d generateQRCode(textInput)\n                            }\n                        },\n                        modifier \u003d Modifier.fillMaxWidth(),\n                        enabled \u003d textInput.isNotEmpty()\n                    ) {\n                        Icon(\n                            imageVector \u003d Icons.Default.QrCode,\n                            contentDescription \u003d null,\n                            modifier \u003d Modifier.padding(end \u003d 8.dp)\n                        )\n                        Text(\&quot;Generate QR Code\&quot;)\n                    }\n                }\n            }\n            \n            Spacer(modifier \u003d Modifier.height(8.dp))\n            \n            // Generated QR Code display\n            if (generatedQRBitmap !\u003d null) {\n                Card(\n                    modifier \u003d Modifier.fillMaxWidth(),\n                    elevation \u003d CardDefaults.cardElevation(defaultElevation \u003d 4.dp),\n                    colors \u003d CardDefaults.cardColors(containerColor \u003d Color.White)\n                ) {\n                    Column(\n                        modifier \u003d Modifier\n                            .fillMaxWidth()\n                            .padding(16.dp),\n                        horizontalAlignment \u003d Alignment.CenterHorizontally\n                    ) {\n                        Box(\n                            modifier \u003d Modifier\n                                .padding(16.dp)\n                                .clip(RoundedCornerShape(8.dp))\n                                .background(Color.White)\n                                .padding(16.dp),\n                            contentAlignment \u003d Alignment.Center\n                        ) {\n                            generatedQRBitmap?.let { bitmap -\u003e\n                                Image(\n                                    bitmap \u003d bitmap.asImageBitmap(),\n                                    contentDescription \u003d \&quot;Generated QR Code\&quot;,\n                                    modifier \u003d Modifier.size(200.dp)\n                                )\n                            }\n                        }\n                    }\n                }\n            }\n            \n            Spacer(modifier \u003d Modifier.weight(1f))\n            \n            // Scan QR Code button\n            Button(\n                onClick \u003d onScanClicked,\n                modifier \u003d Modifier\n                    .fillMaxWidth()\n                    .padding(vertical \u003d 8.dp)\n                    .height(56.dp),\n                colors \u003d ButtonDefaults.buttonColors(containerColor \u003d MaterialTheme.colorScheme.primaryContainer)\n            ) {\n                Icon(\n                    imageVector \u003d Icons.Default.CameraAlt,\n                    contentDescription \u003d null,\n                    modifier \u003d Modifier.padding(end \u003d 8.dp)\n                )\n                Text(\n                    text \u003d \&quot;Scan QR Code\&quot;,\n                    fontSize \u003d 16.sp,\n                    fontWeight \u003d FontWeight.Medium,\n                    color \u003d MaterialTheme.colorScheme.onPrimaryContainer\n                )\n            }\n        }\n    }\n}\n\nprivate fun generateQRCode(content: String): Bitmap {\n    val hints \u003d hashMapOf\u003cEncodeHintType, Any\u003e().apply {\n        put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H)\n        put(EncodeHintType.MARGIN, 2)\n        put(EncodeHintType.CHARACTER_SET, \&quot;UTF-8\&quot;)\n    }\n    \n    val qrCodeWriter \u003d QRCodeWriter()\n    val bitMatrix \u003d qrCodeWriter.encode(\n        content, \n        BarcodeFormat.QR_CODE, \n        512, \n        512,\n        hints\n    )\n    \n    val width \u003d bitMatrix.width\n    val height \u003d bitMatrix.height\n    val bitmap \u003d Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)\n    \n    for (x in 0 until width) {\n        for (y in 0 until height) {\n            bitmap.setPixel(x, y, if (bitMatrix.get(x, y)) Color.Black.value.toInt() else Color.White.value.toInt())\n        }\n    }\n    \n    return bitmap\n}\n```\n\nNow, let\u0027s update the MainActivity to use this new home screen:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/MainActivity.kt\npackage com.serranoie.app.qrrounder\n\nimport android.os.Bundle\nimport android.widget.Toast\nimport androidx.activity.ComponentActivity\nimport androidx.activity.compose.setContent\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport com.serranoie.app.qrrounder.ui.theme.QRRounderTheme\n\nclass MainActivity : ComponentActivity() {\n    private val requestPermissionLauncher \u003d registerForActivityResult(\n        ActivityResultContracts.RequestPermission()\n    ) { granted -\u003e\n        if (!granted) {\n            Toast.makeText(this, \&quot;Camera permission denied\&quot;, Toast.LENGTH_LONG).show()\n            // Don\u0027t finish() here since we now have a home screen that works without camera\n        }\n    }\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContent {\n            QRRounderTheme {\n                var showScanner by remember { mutableStateOf(false) }\n                \n                if (showScanner) {\n                    // Request camera permission when switching to scanner\n                    requestPermissionLauncher.launch(android.Manifest.permission.CAMERA)\n                    QRCodeScannerWithBottomSheet(\n                        onBackPressed \u003d { showScanner \u003d false }\n                    )\n                } else {\n                    HomeScreen(\n                        onScanClicked \u003d { showScanner \u003d true }\n                    )\n                }\n            }\n        }\n    }\n}\n```\n\nAnd finally, let\u0027s update the QRCodeScannerWithBottomSheet to include a back button:\n\n```kotlin:app/src/main/java/com/serranoie/app/qrrounder/QrCodeScannerWIthButtonSheet.kt\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun QRCodeScannerWithBottomSheet(\n    onBackPressed: () -\u003e Unit \u003d {}\n) {\n    val context \u003d LocalContext.current\n    val lifecycleOwner \u003d LocalLifecycleOwner.current\n    val clipboardManager \u003d context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager\n\n    // State management\n    var tapCoordinates by remember { mutableStateOf\u003cOffset?\u003e(null) }\n    var scannedCode by remember { mutableStateOf\u003cString?\u003e(null) }\n    var showSheet by remember { mutableStateOf(false) }\n    val sheetState \u003d rememberModalBottomSheetState(skipPartiallyExpanded \u003d true)\n\n    // Handle focus indicator visibility timeout\n    LaunchedEffect(tapCoordinates) {\n        if (tapCoordinates !\u003d null) {\n            delay(1000)\n            tapCoordinates \u003d null\n        }\n    }\n\n    // Show bottom sheet when QR code is detected\n    if (showSheet \u0026\u0026 scannedCode !\u003d null) {\n        QrCodeBottomSheet(\n            scannedCode \u003d scannedCode.orEmpty(),\n            sheetState \u003d sheetState,\n            onDismiss \u003d {\n                showSheet \u003d false\n                scannedCode \u003d null\n            },\n            onCopy \u003d {\n                clipboardManager.setPrimaryClip(ClipData.newPlainText(\&quot;QR Code\&quot;, scannedCode))\n                Toast.makeText(context, \&quot;Copied to clipboard\&quot;, Toast.LENGTH_SHORT).show()\n            },\n            onShare \u003d {\n                val intent \u003d Intent(Intent.ACTION_SEND).apply {\n                    type \u003d \&quot;text/plain\&quot;\n                    putExtra(Intent.EXTRA_TEXT, scannedCode)\n                }\n                context.startActivity(Intent.createChooser(intent, \&quot;Share QR Code\&quot;))\n            }\n        )\n    }\n\n    Scaffold(\n        topBar \u003d {\n            TopAppBar(\n                title \u003d { Text(\&quot;Scan QR Code\&quot;) },\n                navigationIcon \u003d {\n                    IconButton(onClick \u003d onBackPressed) {\n                        Icon(Icons.Default.ArrowBack, contentDescription \u003d \&quot;Back\&quot;)\n                    }\n                },\n                colors \u003d TopAppBarDefaults.topAppBarColors(\n                    containerColor \u003d MaterialTheme.colorScheme.primaryContainer,\n                    titleContentColor \u003d MaterialTheme.colorScheme.onPrimaryContainer\n                )\n            )\n        }\n    ) { paddingValues -\u003e\n        Box(\n            modifier \u003d Modifier\n                .fillMaxSize()\n                .padding(paddingValues)\n        ) {\n            // Camera preview\n            CameraPreview(\n                onQrCodeScanned \u003d { code -\u003e\n                    if (!showSheet) {\n                        scannedCode \u003d code\n                        showSheet \u003d true\n                    }\n                },\n                onFocusTap \u003d { coordinates -\u003e\n                    tapCoordinates \u003d coordinates\n                }\n            )\n\n            // QR code scanning guide overlay\n            QrCodeScanGuide()\n\n            // Focus indicator overlay\n            FocusIndicator(\n                tapCoordinates \u003d tapCoordinates,\n                showIndicator \u003d tapCoordinates !\u003d null\n            )\n        }\n    }\n}\n```\n\n## Additional Required Imports\n\n```kotlin\n// For MainActivity.kt\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\n\n// For QrCodeScannerWithBottomSheet.kt\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.ArrowBack\nimport androidx.compose.material3.ExperimentalMaterial3Api\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.IconButton\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Scaffold\nimport androidx.compose.material3.TopAppBar\nimport androidx.compose.material3.TopAppBarDefaults\nimport androidx.compose.ui.unit.dp\n\n// For HomeScreen.kt - add zxing library dependency in build.gradle\n// implementation \u0027com.google.zxing:core:3.5.1\u0027\n```\n\n## Explanation\n\n1. **HomeScreen Composable**:\n   - Features a text input field for entering content to generate a QR code\n   - Includes a \&quot;Generate QR Code\&quot; button that uses ZXing to create the QR code\n   - Displays the generated QR code when available\n   - Provides a \&quot;Scan QR Code\&quot; button to navigate to the scanner screen\n   - Uses Material3 components for a consistent look and feel\n\n2. **MainActivity Changes**:\n   - Now manages navigation between the home screen and scanner screen\n   - Only requests camera permission when actually needed (when navigating to scanner)\n   - No longer finishes the activity on camera permission denial, as the home screen is still usable\n\n3. **QRCodeScannerWithBottomSheet Updates**:\n   - Added an optional back button callback\n   - Implemented a Scaffold with TopAppBar for better navigation\n   - Reorganized layout to accommodate the app bar\n\n4. **QR Generation**:\n   - Uses ZXing library to generate QR codes from user input\n   - Creates high-quality QR codes with error correction\n\nThis implementation gives you a complete QR code app with both generation and scanning capabilities. Users can enter text or URLs to generate QR codes, and they can also scan existing QR codes using the device camera.&quot;}]}" />
      </map>
    </option>
  </component>
</project>